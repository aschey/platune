[config]
default_to_workspace = false

[tasks.setup]
script = '''
# precommit hooks
npm install
npm run prepare
# mocking for cli
go install github.com/golang/mock/mockgen@v1.6.0
# cli grpc generation
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.27.1
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.1
# go linting
curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$(go env GOPATH)/bin" v1.43.0
# rust code coverage
rustup component add llvm-tools-preview
'''
script_runner = "@shell"

[tasks.build]
clear = true
script = '''
cargo build ${@}
cd ./platune-cli
go build
'''
script_runner = "@shell"

[tasks.test]
clear = true
script = '''
cargo install cargo-nextest
cargo nextest run --locked -- ${@}
cd ./platune-cli
go test ./...
'''
script_runner = "@shell"

[tasks.lint]
script = '''
cargo clippy
cd ./platune-cli  
golangci-lint run
'''

# autogenerated package from mockgen is slightly wrong, need to remove v2 at the end
[tasks.regen-grpc]
script = '''
cargo clean -p platuned-client -p platuned
cargo build
echo "regenerated rust client/server"

cd platuned/client/go
protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative --proto_path "./../../proto" --go_opt=Mplayer_rpc.proto=github.com/aschey/platune/protos/player_rpc "./../../proto/player_rpc.proto" --go_opt=Mplayer_rpc.proto=github.com/aschey/platune/protos/management_rpc "./../../proto/management_rpc.proto"
echo "regenerated go client"

cd ../../../platune-cli
mockgen -package=test -source="./../platuned/client/go/player_rpc_grpc.pb.go" > "./test/player_mock.go"
mockgen -package=test -source="./../platuned/client/go/management_rpc_grpc.pb.go" > "./test/management_mock.go"
sed -i 's_client/v2_client_g' "./test/player_mock.go"
sed -i 's_client/v2_client_g' "./test/management_mock.go"
echo "regenerated mocks"
'''

[tasks.cli]
script = '''
cd ./platune-cli  
go run . ${@}
'''
script_runner = "@shell"

[tasks.server]
script = '''
cd ./platuned/server 
cargo run ${@}
'''
script_runner = "@shell"

[tasks.win-srv]
condition = {platforms = ["windows"]}
script = '''
cd ./platuned/server  
cargo run --release -- -i
'''

[tasks.systemd]
condition = {platforms = ["linux"]}
script = '''
cp ./platuned/linux/platuned.service /etc/systemd/system/platuned.service
systemctl daemon-reload
systemctl restart platuned
'''

[tasks.verify-features]
args = ["hack", "--feature-powerset", "--exclude-no-default-features", "clippy", "--locked", "--", "-D", "warnings"]
command = "cargo"
install_crate = "cargo-hack"

[tasks.fuzz]
condition = {platforms = ["linux"]}
script = '''
cd libplatune/player/fuzz
makers fuzz
'''

[tasks.gen-coverage]
args = ["test", "--locked"]
command = "cargo"
env = {RUSTFLAGS = "-Cinstrument-coverage", LLVM_PROFILE_FILE = "platune-%p-%m.profraw"}

[tasks.gen-coverage-report]
args = [
  ".",
  "-s",
  ".",
  "--binary-path",
  "./target/debug/",
  "-t",
  "html",
  "--branch",
  "--ignore-not-existing",
  "--ignore",
  "target/debug/**/*",
  "--ignore",
  "**/*/*_test.rs",
  "-o",
  "./target/debug/coverage/",
]
command = "grcov"
dependencies = ["gen-coverage"]
install_crate = {rustup_component_name = "llvm-tools-preview", binary = "grcov"}

[tasks.gen-coverage-ci]
args = [
  ".",
  "-s",
  ".",
  "--binary-path",
  "./target/debug/",
  "-t",
  "lcov",
  "--branch",
  "--ignore-not-existing",
  "--ignore",
  "target/debug/**/*",
  "--ignore",
  "**/*/*_test.rs",
  "-o",
  "./target/debug/lcov.info",
]
command = "grcov"
dependencies = ["gen-coverage"]

[tasks.cleanup-coverage]
clear = true
dependencies = ["gen-coverage-report"]
script = """
handle = glob_array ./**/*.profraw
for path in ${handle}
    rm ${path}
end
"""
script_runner = "@duckscript"

[tasks.coverage]
clear = true
dependencies = ["cleanup-coverage"]
script = "xdg-open target/debug/coverage/index.html"

[tasks.update]
args = ["update"]
command = "cargo"
install_crate = "cargo-add"

[tasks.upgrade]
args = ["upgrade", "--workspace"]
command = "cargo"
install_crate = "cargo-add"

[tasks.update-all]
dependencies = ["update", "upgrade"]
script = '''
cd libplatune/player/fuzz
makers update-all
'''

[tasks.deny]
args = ["deny", "--workspace", "check"]
command = "cargo"
install_crate = "cargo-deny"
