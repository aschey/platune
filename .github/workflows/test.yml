on: [push]

name: CI

jobs:
  rust:
    env:
      SQLX_OFFLINE: true
    name: Run Rust tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: apt-get update
        # act doesn't have sudo installed but it's required on the real actions runner
        run: $(command -v sudo>/dev/null && echo "sudo") apt-get update
      - name: Install deps
        run: $(command -v sudo>/dev/null && echo "sudo") apt-get install -y libssl-dev libasound2-dev cmake build-essential pkg-config git zlib1g-dev
      - name: Install rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true
          profile: minimal
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v1
      - name: Clippy
        run: cargo clippy -- -D warnings
      - name: Test
        run: cargo install cargo-make && rustup component add llvm-tools-preview && makers gen-coverage-ci
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
        with:
          verbose: true
          fail_ci_if_error: true
          files: ./target/debug/lcov.info
  go:
    name: Run Go tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup go
        uses: actions/setup-go@v2
        with:
          go-version: "^1.17"
      - name: Test
        run: cd platune-cli && go build && TERM=xterm-256color script -q -e -c "go test ./... -v"
